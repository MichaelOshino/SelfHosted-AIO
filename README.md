<div align='center'>
 Репозиторий all-in-one (AIO) предназначен для запуска на персональных серверах повседневных сервисов в Docker-контейнерах с использованием Ansible.
 <p> 
</div>

>⚠️  Внимание!  ⚠️   
>Данный репозиторий предназначен для личного использования в легальных целях.   
>Для продакшена потребуется адаптация и тестирование.
__________________________  

**Текущие сервисы** (cписок может пополнятся со временем)**:**  
- [3x-ui](https://github.com/MHSanaei/3x-ui) - веб-панель для управления Xray-core (прокси-сервер);
- [Nextcloud](https://github.com/nextcloud/docker) - облачное хранилище и не только (календарь, контакты, задачи, заметки, и т.д.);   
- [Ryot](https://github.com/IgnisDa/ryot) - повседневный трекер, можно отслеживать: тренировки, фильмы, сериалы, аниме, мангу, визуальные новелы, книги и т.д.; 
- [Firefly-III](https://github.com/firefly-iii/firefly-iii) - финансый менеджер. 

**Требования:**  
Домен привязанный к серверу;  
На сервере должны быть установлены: git, docker, docker-compose-v2, ansible.

__________________________

## Запуск

После подключения по SSH и установки git, docker, docker-compose-v2, ansible выполнить:
```bash
git clone https://github.com/MichaelOshino/SelfHosted-AIO.git && cd SelfHosted-AIO
```
**Выполните предварительную настройку:**   
&emsp; Любым текстовым редактором откройте в директории **group_vars** файл с названием запускаемого сервиса и укажите значения согласно комментариям внутри файла.

Затем через sudo или от root:
```bash
ansible-playbook -i hosts deploy.yml --tags service_name
```
Вместо **service_name** укажите название желаемых сервисов для запуска (возможно перечисление нескольких через запятую без пробела):  
3x-ui  
nextcloud  
ryot  
firefly-iii
__________________________

## Детали и нюансы

### Общее: 
&emsp; После запуска конфигурация и данные сервисов будут находиться в директории: /opt/service_name  
&emsp; В роли реверс-прокси используется traefik - он будет автоматически выпускать сертификаты для доменнов/поддоменов при первом запуске и автоматически их продлевать, он же выполняет перенаправление с http на https. Отключено индексирование поисковиками.

<details>
  <summary>3x-ui</summary>

&emsp; Должен запускаться на отдельном сервере, который будет выполнять только роль прокси-сервера.

Доступные варианты подключений:   
>Протокол: **vless/trojan (оверхед)**  
>Транспорт: **tcp (raw)/xhttp/grpc**  
>Безопасность: **reality**  

>Протокол: **vless/vmess/trojan (оверхед)**  
>Транспорт: **xhttp/websocket/httpupgrade**   
>Безопасность: **TLS**

- С reality трафик идёт напрямую минуя traefik и требуется в панели для подключения указывать 443 порт.
- Для подключения с TLS включайте **External Proxy** в панели и указывайте TLS + домен панели + 443 порт.
- Для работы подписок в настройках, во вкладке "Подписка", укажите **URI обратного прокси** домен панели и путь, например: https://example.com/sub/ 

Стандартные доступы от панели:  
Login: **admin**  
Password: **admin**  
>После первой авторизации обязательно измените в настройках логин и пароль, а так же подключте 2FA.
</details>

<details>
  <summary>Nextcloud</summary>

&emsp; При первом запуске и после обновлений могут возникать предупреждения и требуется вручную, через **occ** внутри контейнера, их исправить.

Нужный контейнер по умолчанию будет называться **nextcloud-nextcloud-app-1**, но чтобы точно увидеть нужный выполните через sudo или от root: 
```bash
docker ps -a --filter "name=nextcloud-app" --format "table {{.ID}}\t{{.Names}}"
```

**Типичные предупреждения и команды для решения:**

>Сервис развертывания AppAPI  
>Демон развертывания AppAPI по умолчанию не установлен.

Если пользоваться не планируете, то достаточно отключить.  
**После отключения будет предупреждение в логах, но должно пропасть в будущих обновлениях nextcloud**
```bash
 docker exec -u www-data -it nextcloud-nextcloud-app-1 php /var/www/html/occ  app:disable app_api 
```
---
>В базе данных отсутствуют некоторые индексы  
>Обнаружены некоторые отсутствующие необязательные индексы. 
```bash
 docker exec -u www-data -it nextcloud-nextcloud-app-1 php /var/www/html/occ  db:add-missing-indices
```
---
>Доступны одна или несколько миграций mimetype.  
>Иногда добавляются новые mimetype для лучшей обработки определенных типов файлов. 
```bash
 docker exec -u www-data -it nextcloud-nextcloud-app-1 php /var/www/html/occ  maintenance:repair --include-expensive
```
---
> В вашей установке не установлен телефонный регион по умолчанию. 

**Формат региона должен быть в ISO 3166-1**
```bash
 docker exec -u www-data -it nextcloud-nextcloud-app-1 php /var/www/html/occ config:system:set default_phone_region --value="RU"
```
---
> Не настроено время начала окна обслуживания. 

**Указать начало с 1 до 24 часа, период обслуживания по умолчанию 4 часа.**
```bash
docker exec -u www-data -it nextcloud-nextcloud-app-1 php /var/www/html/occ config:system:set maintenance_window_start --value="1" --type=integer
```
</details>

<details>
  <summary>Ryot</summary>

&emsp; После создания администратора (первый созданный аккаунт) желательно отключать регистрацию пользователей в переменных окружения, до добавления функции подтверждения регистрации в ryot, и повторить деплой.
</details>

__________________________

## Лицензия

Проект распространяется под лицензией MIT.  
Подробнее см. в файле [LICENSE](https://github.com/MichaelOshino/SelfHosted-AIO/blob/master/LICENSE.md)

В репозитории используются сторонние проекты с различными лицензиями. Ознакомьтесь, пожалуйста, с лицензиями каждого проекта в их собственном репозитории.